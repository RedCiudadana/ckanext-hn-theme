{% extends "package/base.html" %}

{# --- VARIABLES SEGURAS --- #}
{% set pkg = c.pkg_dict %}
{% set res = c.resource %}
{% set resource_views = c.resource_views or [] %}
{% set current_view = c.current_resource_view or {} %}

{# --- MACROS LOCALES (no dependen de h.*) --- #}
{% macro humanize_filesize(bytes) -%}
  {%- if not bytes -%}
    —
  {%- elif bytes < 1024 -%}
{{ bytes }} B
  {%- elif bytes < 1048576 -%}
{{ (bytes / 1024)|round(1) }} KiB
  {%- else -%}
{{ (bytes / 1048576)|round(1) }} MiB
  {%- endif -%}
{%- endmacro %}

{% set size_bytes = res.size | int if res.size else 0 %}
{% set is_csv_like = res.format and res.format.lower() in ['csv', 'txt', 'xlsx', 'xls'] %}
{% set is_small_csv = is_csv_like and size_bytes > 0 and size_bytes < 5242880 %}
{% set can_create_view = h.check_access('resource_view_create', {'resource_id': res.id}) if h.check_access else False %}

{% block subtitle %}{{ h.dataset_display_name(pkg) }} – {{ h.resource_display_name(res) }}{% endblock %}

{% block breadcrumb_content %}
{{ super() }}
<li class="breadcrumb-item active" aria-current="page">{{ h.resource_display_name(res)|truncate(30) }}</li>
{% endblock %}

{% block pre_primary %}
<section class="module module-resource">
    <div class="module-content">
        <!-- Título y acciones -->
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
            <div>
                <h1 class="page-heading">{{ h.resource_display_name(res)|truncate(60) }}</h1>
                {% if res.description %}
                <div class="prose notes text-muted">{{ h.render_markdown(res.description) }}</div>
                {% endif %}
            </div>
            <div>
                <ul class="list-inline mb-0">
                    {% if h.check_access and h.check_access('package_update', {'id': pkg.id}) %}
                    <li class="list-inline-item">
                        <a href="{{ h.url_for(pkg.type ~ '_resource.edit', id=pkg.name, resource_id=res.id) }}"
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fa fa-pencil"></i> {{ _('Edit') }}
                        </a>
                    </li>
                    {% endif %}
                    {% if res.url and h.is_url(res.url) %}
                    <li class="list-inline-item">
                        <a href="{{ res.url }}"
                           class="btn btn-success btn-sm"
                           download="{{ res.name or 'recurso.csv' }}">
                            <i class="fa fa-download"></i> {{ _('Download') }}
                            {% if size_bytes %} ({{ humanize_filesize(size_bytes) }}){% endif %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Vista previa (solo si es CSV pequeño) -->
        {% if is_small_csv %}
        <div class="alert alert-light border mb-4">
            <h4><i class="fa fa-eye text-primary"></i> {{ _('Quick preview (first 5 rows)') }}</h4>
            <div id="preview-{{ res.id }}" class="bg-light p-3 border rounded">
                <p class="text-center text-muted py-2">
                    <i class="fa fa-spinner fa-spin"></i> {{ _('Loading...') }}
                </p>
            </div>
            <small class="text-muted">
                <i class="fa fa-info-circle"></i> {{ _('Preview from original file (no processing).') }}
            </small>
        </div>

        <script>
    document.addEventListener('DOMContentLoaded', function() {
      fetch('{{ res.url }}')
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(txt => {
          const lines = txt.split('\n').filter(l => l.trim());
          if (lines.length < 2) throw 'no data';
          const headers = lines[0].split(',').map(h => h.trim());
          const rows = lines.slice(1, 6).map(l => l.split(',').map(c => c.trim()));

          let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr>';
          headers.forEach(h => html += `<th>${h || '&nbsp;'}</th>`);
          html += '</tr></thead><tbody>';
          rows.forEach(row => {
            html += '<tr>' + headers.map((_, i) => `<td>${row[i] || ''}</td>`).join('') + '</tr>';
          });
          html += '</tbody></table></div>';

          document.getElementById('preview-{{ res.id }}').innerHTML = html;
        })
        .catch(() => {
          document.getElementById('preview-{{ res.id }}').innerHTML =
            '<p class="text-center text-muted py-2"><i class="fa fa-file"></i> {{ _("Preview unavailable") }}</p>';
        });
    });
        </script>
        {% endif %}

        <!-- Estado y CTA -->
        <div class="alert alert-{% if can_create_view %}warning{% else %}info{% endif %}">
            <h4>
                <i class="fa fa-{% if can_create_view %}cogs{% else %}chart-line{% endif %}"></i>
                {% if can_create_view %}
                {{ _('Interactive view can be created') }}
                {% else %}
                {{ _('Interactive view not available yet') }}
                {% endif %}
            </h4>
            <p>
                {% if can_create_view %}
                {{ _('Create a table, chart, or map view for this resource.') }}
                <a href="{{ h.url_for('resource_view.new_view', id=pkg.name, resource_id=res.id) }}"
                   class="btn btn-sm btn-primary mt-2">
                    <i class="fa fa-plus"></i> {{ _('Create view') }}
                </a>
                {% else %}
                {{ _('Contact the data team to request an interactive preview.') }}
                {% endif %}
            </p>
        </div>

        <!-- Vistas existentes -->
        {% if resource_views %}
        <div class="mt-4">
            {% snippet "package/snippets/resource_views_list.html",
            views=resource_views,
            pkg=pkg,
            resource=res,
            view_id=current_view.id,
            is_edit=False
            %}
            {% for view in resource_views %}
            {% if view.id == current_view.id %}
            {% snippet "package/snippets/resource_view.html", resource_view=view, resource=res, package=pkg %}
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block primary_content %}
<section class="module">
    <div class="module-content">
        <h2>{{ _('Additional Information') }}</h2>
        <table class="table table-striped">
            <tr><th>{{ _('Format') }}</th><td>{{ res.format or '—' }}</td></tr>
            <tr><th>{{ _('Created') }}</th><td>{{ h.render_datetime(res.created) or '—' }}</td></tr>
            <tr><th>{{ _('Data last updated') }}</th><td>{{ h.render_datetime(res.last_modified) or h.render_datetime(res.created) or '—' }}</td></tr>
            <tr><th>{{ _('Size') }}</th><td>{{ humanize_filesize(size_bytes) }}</td></tr>
            <tr>
                <th>{{ _('Datastore active') }}</th>
                <td>
                    {% if res.datastore_active %}<span class="text-success"><i class="fa fa-check"></i> Yes</span>
                    {% else %}<span class="text-warning"><i class="fa fa-times"></i> No</span>{% endif %}
                </td>
            </tr>
            <tr>
                <th>{{ _('Has views') }}</th>
                <td>
                    {% if res.has_views %}<span class="text-success"><i class="fa fa-check"></i> Yes</span>
                    {% else %}<span class="text-muted"><i class="fa fa-times"></i> No</span>{% endif %}
                </td>
            </tr>
        </table>
    </div>
</section>
{% endblock %}

{% block secondary_content %}
  {% snippet "package/snippets/resources.html", pkg=pkg, active=res.id %}
  {% snippet "snippets/social.html" %}
{% endblock %}