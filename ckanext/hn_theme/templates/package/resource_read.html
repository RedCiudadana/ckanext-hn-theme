{% extends "package/base.html" %}

{% set res = resource %}

{% block head_extras -%}
{{ super() }}
  {% set description = h.markdown_extract(h.get_translated(res, 'description'), extract_length=200) if res.description else h.markdown_extract(h.get_translated(package, 'notes'), extract_length=200) %}
<meta property="og:title" content="{{ h.dataset_display_name(package) }} - {{ h.resource_display_name(res) }} - {{ g.site_title }}">
<meta property="og:description" content="{{ description|forceescape }}">
{% endblock -%}

{% block subtitle %}{{ h.dataset_display_name(package) }} {{ g.template_title_delimiter }} {{ h.resource_display_name(res) }}{% endblock %}

{% block breadcrumb_content %}
{{ super() }}
<li class="breadcrumb-item active" aria-current="page">
    <span aria-label="{{ _('Recurso actual: {name}').format(name=h.resource_display_name(res)) }}">
        {{ h.resource_display_name(res)|truncate(30) }}
    </span>
</li>
{% endblock %}

{% block pre_primary %}
  {% block resource %}
<section class="module module-resource" role="complementary">
    {% block resource_inner %}
    <div class="module-content">
        <div class="actions">
            {% block resource_actions %}
            <ul class="d-flex flex-wrap gap-2 justify-content-end">
                {% block resource_actions_inner %}
                {% block action_manage %}
                {% if h.check_access('package_update', {'id':pkg.id }) %}
                <li>{% link_for _('Editar recurso'), named_route=pkg.type ~ '_resource.edit', id=pkg.name, resource_id=res.id, class_='btn btn-outline-secondary btn-sm', icon='pencil' %}</li>
                {% block action_manage_inner %}{% endblock %}
                <li>{% link_for _('Vistas'), named_route=pkg.type ~ '_resource.views', id=pkg.name, resource_id=res.id, class_='btn btn-outline-secondary btn-sm', icon='chart-bar' %}</li>
                {% endif %}
                {% endblock action_manage %}
                {% if res.url and h.is_url(res.url) %}
                <li>
                    <div class="btn-group" role="group">
                        <a class="btn btn-primary btn-sm resource-url-analytics" href="{{ res.url }}">
                            {% if res.resource_type in ('listing', 'service') %}
                            <i class="fa fa-eye"></i> {{ _('Ver') }}
                            {% elif  res.resource_type == 'api' %}
                            <i class="fa fa-key"></i> {{ _('Endpoint de API') }}
                            {% elif not res.has_views and not res.url_type == 'upload' %}
                            <i class="fa fa-external-link"></i> {{ _('Ir al recurso') }}
                            {% else %}
                            <i class="fa fa-arrow-circle-down"></i> {{ _('Descargar') }}
                            {% endif %}
                        </a>
                        {% block download_resource_button %}{% endblock download_resource_button %}
                    </div>
                </li>
                {% endif %}

                {% endblock %}
            </ul>
            {% endblock %}
        </div>



        {% block resource_content %}
        <h1 class="page-heading mb-3">{{ h.resource_display_name(res) | truncate(60) }}</h1>

        {% if res.description %}
        <div class="prose notes mb-4">{{ h.render_markdown(res.description) }}</div>
        {% endif %}

        {% if not res.description and package.notes %}
        <div class="prose notes mb-4">
            <h3 class="h5 text-muted mb-2">{{ _('Descripción del conjunto de datos:') }}</h3>
            <blockquote class="blockquote">{{ h.markdown_extract(h.get_translated(package, 'notes')) }}</blockquote>
            <p class="text-muted small">
                {% trans dataset=h.get_translated(package, 'title'), url=h.url_for(package.type ~ '.read', id=package.name) %}
                Fuente: <a href="{{ url }}">{{ dataset }}</a>
                {% endtrans %}
            </p>
        </div>
        {% endif %}

        <!-- URL del recurso -->
        {% if res.url and h.is_url(res.url) %}
        <div class="card bg-light mb-4">
            <div class="card-body p-3">
                <h5 class="card-title mb-1"><i class="fa fa-link text-muted me-2"></i>{{ _('URL del recurso') }}</h5>
                <p class="card-text mb-0 text-break">
                    <a href="{{ res.url }}" class="resource-url-analytics text-decoration-none" target="_blank">
                        <i class="fa fa-external-link me-1 text-muted"></i>{{ res.url | truncate(80) }}
                    </a>
                </p>
            </div>
        </div>
        {% elif res.url %}
        <div class="card bg-light mb-4">
            <div class="card-body p-3">
                <h5 class="card-title mb-1"><i class="fa fa-file text-muted me-2"></i>{{ _('Ruta del archivo') }}</h5>
                <p class="card-text mb-0"><code>{{ res.url }}</code></p>
            </div>
        </div>
        {% endif %}
        <!-- ✅ VISTA PREVIA INTELIGENTE (con Data API y fallback) -->
        {% if res.format and res.format.lower() in ['csv', 'txt'] and res.id and res.size and res.size < 5242880 %}
        <div class="mb-4">
            <button class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-between w-100"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#smart-preview-{{ res.id }}"
                    aria-expanded="false"
                    aria-controls="smart-preview-{{ res.id }}"
                    onclick="initSmartPreview(this, '{{ res.id }}', {{ 'true' if res.datastore_active else 'false' }})">
                <span>
                    <i class="fa fa-eye me-2"></i>
                    {{ _('Ver vista previa (primeras 5 filas)') }}
                </span>
                <i class="fa fa-chevron-right chevron-toggle"></i>
            </button>

            <div class="collapse mt-3" id="smart-preview-{{ res.id }}">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center small">
                        <span><i class="fa fa-table me-1"></i> {{ _('Datos de ejemplo') }}</span>
                        <span class="badge bg-secondary">{{ res.format.upper() }}</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="smart-preview-content-{{ res.id }}" class="p-3" style="min-height: 60px;">
                            <p class="text-center text-muted py-2">
                                <i class="fa fa-spinner fa-spin me-1"></i> {{ _('Cargando...') }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        function initSmartPreview(btn, resourceId, datastoreActive) {
          const collapse = document.getElementById('smart-preview-' + resourceId);
          const content = document.getElementById('smart-preview-content-' + resourceId);
          const chevron = btn.querySelector('.chevron-toggle');

          // Rotar ícono inmediatamente
          chevron.classList.toggle('fa-chevron-right');
          chevron.classList.toggle('fa-chevron-down');

          // Solo cargar la primera vez
          if (collapse.hasAttribute('data-loaded')) return;

          if (datastoreActive) {
            // ✅ Opción 1: DataStore (rápido y oficial)
            fetch('/api/3/action/datastore_search?resource_id=' + resourceId + '&limit=5')
              .then(r => r.json())
              .then(data => {
                if (data.success && data.result.records) {
                  renderTable(content, data.result.fields, data.result.records);
                } else {
                  content.innerHTML = `<p class="text-center text-muted py-2">{{ _('Vista previa no disponible') }}</p>`;
                }
              })
              .catch(() => {
                content.innerHTML = `<p class="text-center text-muted py-2">{{ _('Error al cargar desde DataStore') }}</p>`;
              })
              .finally(() => collapse.setAttribute('data-loaded', 'true'));
          } else {
              // ✅ Opción 2a: Si es URL externa → usar proxy de CKAN
              const isExternal = !('{{ res.url_type }}' === 'upload');
              const proxyUrl = isExternal
                  ? '/api/3/action/resource_proxy?url=' + encodeURIComponent('{{ res.url | replace("\\", "\\\\") }}')
                  : '/dataset/{{ package.name }}/resource/' + resourceId + '/download/{{ res.name | replace(" ", "%20") if res.name else "recurso.csv" }}';

              fetch(proxyUrl)
                  .then(r => {
                      if (!r.ok) throw new Error('HTTP ' + r.status);
                      return r.text();
                  })
                  .then(text => {
                      // Truncar para evitar sobrecarga (solo primeros 50 KB)
                      if (text.length > 50000) {
                          // Buscar el final de la quinta línea (o truncar con \n)
                          const lines = text.split('\n');
                          text = lines.slice(0, 6).join('\n');
                      }
                      const lines = text.split('\n').filter(l => l.trim());
                      if (lines.length < 1) throw new Error('empty');
                      const headers = lines[0].split(',').map(h => h.trim());
                      const rows = lines.slice(1, 6).map(line => line.split(',').map(cell => cell.trim()));
                      renderTable(content, headers, rows);
                  })
                  .catch(err => {
                      console.warn('Preview failed:', err);
                      content.innerHTML = `
        <div class="p-3 text-center">
          <p class="mb-2"><i class="fa fa-exclamation-triangle text-warning me-1"></i> {{ _('No se pudo cargar la vista previa') }}</p>
          <p class="small text-muted mb-2">
            {% if '{{ res.url_type }}' == 'upload' %}
              {{ _('El recurso no está accesible o es demasiado grande.') }}
            {% else %}
              {{ _('No se pudo acceder al recurso externo. Puede estar caído o bloqueado.') }}
            {% endif %}
          </p>
          {% if h.check_access('resource_view_create', {'resource_id': res.id}) %}
          <a href="{{ h.url_for(pkg.type ~ '_resource.views', id=pkg.name, resource_id=res.id) }}"
             class="btn btn-sm btn-outline-primary">
            <i class="fa fa-cogs me-1"></i> {{ _('Procesar ahora') }}
          </a>
          {% endif %}
        </div>`;
                  })
                  .finally(() => collapse.setAttribute('data-loaded', 'true'));
          }
        }

        function renderTable(container, headers, rows) {
          let html = '<div class="table-responsive"><table class="table table-sm mb-0"><thead><tr>';
          headers.forEach(h => html += `<th scope="col">${h || '&nbsp;'}</th>`);
          html += '</tr></thead><tbody>';
          rows.forEach(row => {
            html += '<tr>';
            for (let i = 0; i < headers.length; i++) {
              const cell = row[i] || '';
              // Escapar HTML para seguridad
              const safeCell = cell.replace(/&/g, '&amp;').replace(/</g, '<').replace(/>/g, '>');
              html += `<td>${safeCell}</td>`;
            }
            html += '</tr>';
          });
          html += '</tbody></table></div>';
          container.innerHTML = html;
        }
        </script>
        {% endif %}
        {% endblock %}

        {% block data_preview %}
        {% block resource_view %}
        {% block resource_view_nav %}
        {% snippet "package/snippets/resource_views_list.html",
        views=resource_views,
        pkg=pkg,
        is_edit=false,
        view_id=current_resource_view['id'],
        resource=resource,
        extra_class="nav-tabs"
        %}
        {% endblock %}
        {% block resource_view_content %}
        <div class="resource-view">
            {% if resource_views %}
            {% for resource_view in resource_views %}
            {% if resource_view == current_resource_view %}
            {% snippet 'package/snippets/resource_view.html',
            resource_view=resource_view,
            resource=resource,
            package=package
            %}
            {% endif %}
            {% endfor %}
            {% else %}
            {# Vistas no creadas — versión visual mejorada #}
            <div class="alert alert-light border rounded p-4 mb-4">
                <div class="d-flex align-items-start">
                    <div class="me-3 mt-1">
                        <i class="fa fa-chart-bar fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h4 class="alert-heading mb-2">{{ _('Vistas interactivas') }}</h4>
                        <p class="mb-3">
                            <i class="fa fa-exclamation-triangle text-warning me-1"></i>
                            {{ _('Todavía no existen vistas creadas para este recurso.') }}
                        </p>

                        {% if h.check_access('resource_view_create', {'resource_id': resource.id}) %}
                        <div class="alert alert-warning p-3 mb-0">
                            <p class="mb-2">
                                <strong>{{ _('💡 Consejo para editores:') }}</strong><br>
                                {{ _('Puede crear una vista de tabla, gráfico o mapa utilizando el botón \'Vistas\' que aparece arriba.') }}
                            </p>
                            <a href="{{ h.url_for(pkg.type ~ '_resource.views', id=pkg.name, resource_id=res.id) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="fa fa-chart-bar me-1"></i> {{ _('Ir a Vistas') }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {# Acordion técnico — mantenido para compatibilidad #}
                {% if h.check_access('resource_view_create', {'resource_id': resource.id}) %}
                <div class="mt-4">
                    <p class="text-muted small">
                        <i class="fa fa-info-circle me-1"></i>
                        {{ _('¿No ve las vistas que esperaba?') }}
                        <a href="javascript:void(0);" data-bs-toggle="collapse" data-bs-target="#data-view-info">
                            {{ _('Haga clic aquí para más información.') }}
                        </a>
                    </p>
                    <div id="data-view-info" class="collapse mt-2">
                        <p class="small mb-2">{{ _('Estas son algunas razones por las que podría no estar viendo las vistas esperadas:') }}</p>
                        <ul class="small mb-0">
                            <li>{{ _('No se ha creado ninguna vista adecuada para este recurso.') }}</li>
                            <li>{{ _('Es posible que los administradores del sitio no hayan habilitado los complementos de vista relevantes.') }}</li>
                            <li>{{ _('Si una vista requiere DataStore, es posible que el complemento DataStore no esté habilitado, que los datos no se hayan enviado a DataStore o que DataStore aún no haya terminado de procesar los datos.') }}</li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endblock %}
        {% endblock %}
        {% endblock %}
    </div>
    {% endblock %}
</section>
  {% endblock %}
{% endblock %}

{% block primary_content %}
  {% block resource_additional_information %}
    {% if res %}
<section class="module">
    {% block resource_additional_information_inner %}
    <div class="module-content">
        <h2 class="mb-4">{{ _('Información adicional') }}</h2>
        <table class="table table-striped table-hover">
            <tbody>
                <tr>
                    <th scope="row">{{ _('Última actualización de los datos') }}</th>
                    <td>{{ h.render_datetime(res.last_modified) or h.render_datetime(res.created) or _('desconocida') }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Última actualización de los metadatos') }}</th>
                    <td>{{ h.render_datetime(res.metadata_modified) or h.render_datetime(res.created) or _('desconocida') }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Creado') }}</th>
                    <td>{{ h.render_datetime(res.created) or _('desconocido') }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Formato') }}</th>
                    <td>
                        <span class="badge bg-secondary">{{ res.format.upper() or '—' }}</span>
                    </td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Licencia') }}</th>
                    <td>{% snippet "snippets/license.html", pkg_dict=pkg, text_only=True %}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Tamaño') }}</th>
                    <td>{{ res.size | filesizeformat or '—' }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Datastore activo') }}</th>
                    <td>
                        {% if res.datastore_active %}
                        <span class="text-success"><i class="fa fa-check-circle me-1"></i> {{ _('Sí') }}</span>
                        {% else %}
                        <span class="text-warning"><i class="fa fa-clock me-1"></i> {{ _('No') }}</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Tiene vistas') }}</th>
                    <td>
                        {% if res.has_views %}
                        <span class="text-success"><i class="fa fa-check-circle me-1"></i> {{ _('Sí') }}</span>
                        {% else %}
                        <span class="text-muted"><i class="fa fa-times-circle me-1"></i> {{ _('No') }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% for key, value in h.format_resource_items(res.items()) %}
                {% if key not in ('created', 'metadata modified', 'last modified', 'format', 'size', 'datastore_active', 'has_views') %}
                <tr class="toggle-more">
                    <th scope="row">{{ key | capitalize }}</th>
                    <td>{{ value }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endblock %}
</section>
    {% endif %}
  {% endblock %}
{% endblock %}

{% block secondary_content %}
  {% block resources_list %}
    {% snippet "package/snippets/resources.html", pkg=pkg, active=res.id, action='read' %}
  {% endblock %}
  {% block resource_social %}
    {% snippet "snippets/social.html" %}
  {% endblock %}
{% endblock %}