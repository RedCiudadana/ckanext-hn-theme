{% extends "package/base.html" %}

{% set res = resource %}

{% block head_extras -%}
{{ super() }}
  {% set description = h.markdown_extract(h.get_translated(res, 'description'), extract_length=200) if res.description else h.markdown_extract(h.get_translated(package, 'notes'), extract_length=200) %}
<meta property="og:title" content="{{ h.dataset_display_name(package) }} - {{ h.resource_display_name(res) }} - {{ g.site_title }}">
<meta property="og:description" content="{{ description|forceescape }}">
{% endblock -%}

{% block subtitle %}{{ h.dataset_display_name(package) }} {{ g.template_title_delimiter }} {{ h.resource_display_name(res) }}{% endblock %}

{% block breadcrumb_content %}
{{ super() }}
<li class="breadcrumb-item active" aria-current="page">
    <span aria-label="{{ _('Recurso actual: {name}').format(name=h.resource_display_name(res)) }}">
        {{ h.resource_display_name(res)|truncate(30) }}
    </span>
</li>
{% endblock %}

{% block pre_primary %}
  {% block resource %}
<section class="module module-resource" role="complementary">
    {% block resource_inner %}
    <div class="module-content">
        <div class="actions">
            {% block resource_actions %}
            <ul class="d-flex flex-wrap gap-2 justify-content-end">
                {% block resource_actions_inner %}
                {% block action_manage %}
                {% if h.check_access('package_update', {'id':pkg.id }) %}
                <li>{% link_for _('Editar recurso'), named_route=pkg.type ~ '_resource.edit', id=pkg.name, resource_id=res.id, class_='btn btn-outline-secondary btn-sm', icon='pencil' %}</li>
                {% block action_manage_inner %}{% endblock %}
                <li>{% link_for _('Vistas'), named_route=pkg.type ~ '_resource.views', id=pkg.name, resource_id=res.id, class_='btn btn-outline-secondary btn-sm', icon='chart-bar' %}</li>
                {% endif %}
                {% endblock action_manage %}
                {% if res.url and h.is_url(res.url) %}
                <li>
                    <div class="btn-group" role="group">
                        <a class="btn btn-primary btn-sm resource-url-analytics" href="{{ res.url }}">
                            {% if res.resource_type in ('listing', 'service') %}
                            <i class="fa fa-eye"></i> {{ _('Ver') }}
                            {% elif  res.resource_type == 'api' %}
                            <i class="fa fa-key"></i> {{ _('Endpoint de API') }}
                            {% elif not res.has_views and not res.url_type == 'upload' %}
                            <i class="fa fa-external-link"></i> {{ _('Ir al recurso') }}
                            {% else %}
                            <i class="fa fa-arrow-circle-down"></i> {{ _('Descargar') }}
                            {% endif %}
                        </a>
                        {% block download_resource_button %}{% endblock download_resource_button %}
                    </div>
                </li>
                {% endif %}

                {% endblock %}
            </ul>
            {% endblock %}
        </div>



        {% block resource_content %}
        <h1 class="page-heading mb-3">{{ h.resource_display_name(res) | truncate(60) }}</h1>

        {% if res.description %}
        <div class="prose notes mb-4">{{ h.render_markdown(res.description) }}</div>
        {% endif %}

        {% if not res.description and package.notes %}
        <div class="prose notes mb-4">
            <h3 class="h5 text-muted mb-2">{{ _('Descripción del conjunto de datos:') }}</h3>
            <blockquote class="blockquote">{{ h.markdown_extract(h.get_translated(package, 'notes')) }}</blockquote>
            <p class="text-muted small">
                {% trans dataset=h.get_translated(package, 'title'), url=h.url_for(package.type ~ '.read', id=package.name) %}
                Fuente: <a href="{{ url }}">{{ dataset }}</a>
                {% endtrans %}
            </p>
        </div>
        {% endif %}

        <!-- URL del recurso -->
        {% if res.url and h.is_url(res.url) %}
        <div class="card bg-light mb-4">
            <div class="card-body p-3">
                <h5 class="card-title mb-1"><i class="fa fa-link text-muted me-2"></i>{{ _('URL del recurso') }}</h5>
                <p class="card-text mb-0 text-break">
                    <a href="{{ res.url }}" class="resource-url-analytics text-decoration-none" target="_blank">
                        <i class="fa fa-external-link me-1 text-muted"></i>{{ res.url | truncate(80) }}
                    </a>
                </p>
            </div>
        </div>
        {% elif res.url %}
        <div class="card bg-light mb-4">
            <div class="card-body p-3">
                <h5 class="card-title mb-1"><i class="fa fa-file text-muted me-2"></i>{{ _('Ruta del archivo') }}</h5>
                <p class="card-text mb-0"><code>{{ res.url }}</code></p>
            </div>
        </div>
        {% endif %}
        <!-- ✅ Vista previa: CSV -->
        {% if res.format and res.format.lower() in ['csv', 'txt', 'xlsx', 'xls'] and res.size and res.size < 5242880 and res.id %}
        <div class="mb-4">
            <button class="btn btn-outline-primary btn-sm d-flex align-items-center justify-content-between w-100"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#preview-csv-{{ res.id }}"
                    aria-expanded="false"
                    aria-controls="preview-csv-{{ res.id }}">
                <span><i class="fa fa-table me-2"></i> {{ _('Vista previa de tabla (CSV/Excel)') }}</span>
                <i class="fa fa-chevron-right"></i>
            </button>
            <div class="collapse mt-3" id="preview-csv-{{ res.id }}">
                <div class="card">
                    <div class="card-header bg-light small">
                        <i class="fa fa-file-csv me-1"></i> {{ _('Primeras 5 filas') }}
                    </div>
                    <div class="card-body p-3">
                        <div class="text-center py-2" id="csv-preview-{{ res.id }}">
                            <button class="btn btn-sm btn-primary" onclick="loadCsvPreview('{{ res.id }}', '{{ package.name }}', '{{ res.name | replace(' ', '%20') if res.name else 'recurso.csv' }}')">
                                <i class="fa fa-play me-1"></i> {{ _('Cargar vista previa') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- ✅ Vista previa: JSON -->
        {% if res.format and res.format.lower() == 'json' and res.size and res.size < 2097152 and res.id %}
        <div class="mb-4">
            <button class="btn btn-outline-success btn-sm d-flex align-items-center justify-content-between w-100"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#preview-json-{{ res.id }}"
                    aria-expanded="false"
                    aria-controls="preview-json-{{ res.id }}">
                <span><i class="fa fa-code me-2"></i> {{ _('Vista previa de estructura (JSON)') }}</span>
                <i class="fa fa-chevron-right"></i>
            </button>
            <div class="collapse mt-3" id="preview-json-{{ res.id }}">
                <div class="card">
                    <div class="card-header bg-light small">
                        <i class="fa fa-brackets-curly me-1"></i> {{ _('Primer nivel de claves') }}
                    </div>
                    <div class="card-body p-3">
                        <div class="text-center py-2" id="json-preview-{{ res.id }}">
                            <button class="btn btn-sm btn-success" onclick="loadJsonPreview('{{ res.id }}', '{{ package.name }}', '{{ res.name | replace(' ', '%20') if res.name else 'recurso.json' }}')">
                                <i class="fa fa-play me-1"></i> {{ _('Cargar estructura') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endblock %}

        {% block data_preview %}
        {% block resource_view %}
        {% block resource_view_nav %}
        {% snippet "package/snippets/resource_views_list.html",
        views=resource_views,
        pkg=pkg,
        is_edit=false,
        view_id=current_resource_view['id'],
        resource=resource,
        extra_class="nav-tabs"
        %}
        {% endblock %}
        {% block resource_view_content %}
        <div class="resource-view">
            {% if resource_views %}
            {% for resource_view in resource_views %}
            {% if resource_view == current_resource_view %}
            {% snippet 'package/snippets/resource_view.html',
            resource_view=resource_view,
            resource=resource,
            package=package
            %}
            {% endif %}
            {% endfor %}
            {% else %}
            {# Vistas no creadas — versión visual mejorada #}
            <div class="alert alert-light border rounded p-4 mb-4">
                <div class="d-flex align-items-start">
                    <div class="me-3 mt-1">
                        <i class="fa fa-chart-bar fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h4 class="alert-heading mb-2">{{ _('Vistas interactivas') }}</h4>
                        <p class="mb-3">
                            <i class="fa fa-exclamation-triangle text-warning me-1"></i>
                            {{ _('Todavía no existen vistas creadas para este recurso.') }}
                        </p>

                        {% if h.check_access('resource_view_create', {'resource_id': resource.id}) %}
                        <div class="alert alert-warning p-3 mb-0">
                            <p class="mb-2">
                                <strong>{{ _('💡 Consejo para editores:') }}</strong><br>
                                {{ _('Puede crear una vista de tabla, gráfico o mapa utilizando el botón \'Vistas\' que aparece arriba.') }}
                            </p>
                            <a href="{{ h.url_for(pkg.type ~ '_resource.views', id=pkg.name, resource_id=res.id) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="fa fa-chart-bar me-1"></i> {{ _('Ir a Vistas') }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {# Acordion técnico — mantenido para compatibilidad #}
                {% if h.check_access('resource_view_create', {'resource_id': resource.id}) %}
                <div class="mt-4">
                    <p class="text-muted small">
                        <i class="fa fa-info-circle me-1"></i>
                        {{ _('¿No ve las vistas que esperaba?') }}
                        <a href="javascript:void(0);" data-bs-toggle="collapse" data-bs-target="#data-view-info">
                            {{ _('Haga clic aquí para más información.') }}
                        </a>
                    </p>
                    <div id="data-view-info" class="collapse mt-2">
                        <p class="small mb-2">{{ _('Estas son algunas razones por las que podría no estar viendo las vistas esperadas:') }}</p>
                        <ul class="small mb-0">
                            <li>{{ _('No se ha creado ninguna vista adecuada para este recurso.') }}</li>
                            <li>{{ _('Es posible que los administradores del sitio no hayan habilitado los complementos de vista relevantes.') }}</li>
                            <li>{{ _('Si una vista requiere DataStore, es posible que el complemento DataStore no esté habilitado, que los datos no se hayan enviado a DataStore o que DataStore aún no haya terminado de procesar los datos.') }}</li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endblock %}
        {% endblock %}
        {% endblock %}
    </div>
    {% endblock %}
</section>
  {% endblock %}
{% endblock %}

{% block primary_content %}
  {% block resource_additional_information %}
    {% if res %}
<section class="module">
    {% block resource_additional_information_inner %}
    <div class="module-content">
        <h2 class="mb-4">{{ _('Información adicional') }}</h2>
        <table class="table table-striped table-hover">
            <tbody>
                <tr>
                    <th scope="row">{{ _('Última actualización de los datos') }}</th>
                    <td>{{ h.render_datetime(res.last_modified) or h.render_datetime(res.created) or _('desconocida') }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Última actualización de los metadatos') }}</th>
                    <td>{{ h.render_datetime(res.metadata_modified) or h.render_datetime(res.created) or _('desconocida') }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Creado') }}</th>
                    <td>{{ h.render_datetime(res.created) or _('desconocido') }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Formato') }}</th>
                    <td>
                        <span class="badge bg-secondary">{{ res.format.upper() or '—' }}</span>
                    </td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Licencia') }}</th>
                    <td>{% snippet "snippets/license.html", pkg_dict=pkg, text_only=True %}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Tamaño') }}</th>
                    <td>{{ res.size | filesizeformat or '—' }}</td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Datastore activo') }}</th>
                    <td>
                        {% if res.datastore_active %}
                        <span class="text-success"><i class="fa fa-check-circle me-1"></i> {{ _('Sí') }}</span>
                        {% else %}
                        <span class="text-warning"><i class="fa fa-clock me-1"></i> {{ _('No') }}</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">{{ _('Tiene vistas') }}</th>
                    <td>
                        {% if res.has_views %}
                        <span class="text-success"><i class="fa fa-check-circle me-1"></i> {{ _('Sí') }}</span>
                        {% else %}
                        <span class="text-muted"><i class="fa fa-times-circle me-1"></i> {{ _('No') }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% for key, value in h.format_resource_items(res.items()) %}
                {% if key not in ('created', 'metadata modified', 'last modified', 'format', 'size', 'datastore_active', 'has_views') %}
                <tr class="toggle-more">
                    <th scope="row">{{ key | capitalize }}</th>
                    <td>{{ value }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endblock %}
</section>
    {% endif %}
  {% endblock %}
{% endblock %}

{% block secondary_content %}
  {% block resources_list %}
    {% snippet "package/snippets/resources.html", pkg=pkg, active=res.id, action='read' %}
  {% endblock %}
  {% block resource_social %}
    {% snippet "snippets/social.html" %}
  {% endblock %}
{% endblock %}