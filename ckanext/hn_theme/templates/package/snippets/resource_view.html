{% set is_csv_like = res.format.lower() in ['csv', 'txt', 'xlsx', 'xls'] %}
{% set can_create_view = h.check_access('resource_view_create', {'resource_id': res.id}) %}

<div class="module module-resource">
    <div class="module-content">
        <h1 class="heading">{{ h.resource_display_name(res) }}</h1>

        {% if res.description %}
        <div class="notes embedded-content">{{ h.render_markdown(res.description) }}</div>
        {% endif %}

        <!-- 🔹 Sección: Vista previa inteligente (solo para CSV/Excel pequeños) -->
        {% if is_csv_like and res.size < 5242880 %}  {# < 5 MB #}
        <div class="alert alert-info mb-4" style="background-color: #f8f9fa; border-left: 4px solid #17a2b8;">
            <h4 class="alert-heading">
                <i class="fas fa-eye me-2"></i> Vista previa rápida (primeras 5 filas)
            </h4>
            <p class="mb-2">
                Archivo: <code>{{ res.name or res.id }}</code> • {{ h.humanize_filesize(res.size) }}
            </p>
            <div id="quick-preview-{{ res.id }}" class="bg-white p-3 border rounded">
                <p class="text-center text-muted" style="margin: 1.5rem 0;">
                    <i class="fas fa-spinner fa-spin me-2"></i> Cargando vista previa…
                </p>
            </div>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-info-circle me-1"></i> Los datos se leen directamente del archivo subido. No requiere procesamiento previo.
            </small>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
          fetch('{{ res.url }}')
            .then(response => {
              if (!response.ok) throw new Error('Archivo no accesible');
              return response.text();
            })
            .then(text => {
              // Parser básico de CSV (soporta comillas, comas en celdas)
              const lines = text.split('\n').filter(l => l.trim() !== '');
              const headers = lines[0] ? lines[0].split(',').map(h => h.trim()) : ['Columna 1'];
              const rows = lines.slice(1, 6).map(line => line.split(',').map(cell => cell.trim()));

              let html = '<table class="table table-sm table-bordered"><thead><tr>';
              headers.forEach(h => html += `<th scope="col">${h || '&nbsp;'}</th>`);
              html += '</tr></thead><tbody>';

              if (rows.length === 0) {
                html += '<tr><td colspan="' + headers.length + '" class="text-center text-muted">Sin datos</td></tr>';
              } else {
                rows.forEach(row => {
                  html += '<tr>';
                  for (let i = 0; i < headers.length; i++) {
                    html += `<td>${row[i] || '&nbsp;'}</td>`;
                  }
                  html += '</tr>';
                });
              }
              html += '</tbody></table>';

              document.getElementById('quick-preview-{{ res.id }}').innerHTML = html;
            })
            .catch(err => {
              document.getElementById('quick-preview-{{ res.id }}').innerHTML =
                `<p class="text-center text-danger"><i class="fas fa-exclamation-triangle me-1"></i> No se pudo cargar la vista previa. ` +
                `Verifique que el archivo esté subido correctamente.</p>`;
            });
        });
        </script>
        {% endif %}

        <!-- 🔹 Mensaje de estado + llamado a la acción -->
        <div class="alert alert-{{ 'warning' if can_create_view else 'info' }} mb-4">
            {% if can_create_view %}
            <h4 class="alert-heading">
                <i class="fas fa-cogs me-2"></i> Previsualización interactiva disponible
            </h4>
            <p>
                Puede habilitar una <strong>vista interactiva</strong> (tabla filtrable, gráfico o mapa) para este recurso.
            </p>
            <a href="{{ h.url_for('resource_view.new_view', id=pkg.name, resource_id=res.id) }}"
               class="btn btn-sm btn-primary mt-2">
                <i class="fas fa-plus me-1"></i> Crear vista ahora
            </a>
            <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip"
                    title="Requiere formato CSV/Excel válido y menos de 100 MB. El sistema generará automáticamente una tabla editable.">
                <i class="fas fa-question-circle text-muted"></i>
            </button>
            {% else %}
            <h4 class="alert-heading">
                <i class="fas fa-chart-line me-2"></i> ¿Te gustaría explorar estos datos?
            </h4>
            <p>
                Este recurso aún no tiene una vista interactiva. Si tenés acceso institucional, podés solicitar su habilitación.
            </p>
            {% if h.mail_to(email_address='datos-abiertos@tuinstitucion.gob.hn', name='Soporte Técnico') %}
            <a href="mailto:datos-abiertos@tuinstitucion.gob.hn?subject=Solicitud%20de%20vista%20para%20recurso%20{{ res.id }}&body=Recurso:%20{{ res.name }}%0ADataset:%20{{ pkg.title }}%0AID:%20{{ res.id }}"
               class="btn btn-sm btn-outline-secondary mt-2">
                <i class="fas fa-envelope me-1"></i> Solicitar previsualización
            </a>
            {% endif %}
            {% endif %}
        </div>

        <!-- 🔹 Botones principales (mejorados) -->
        <div class="btn-group mb-4" role="group">
            {% if res.url and h.is_url(res.url) %}
            <a href="{{ res.url }}" class="btn btn-success btn-lg" download="{{ res.name or 'recurso.csv' }}">
                <i class="fas fa-download me-2"></i> Descargar ({{ h.humanize_filesize(res.size) }})
            </a>
            {% if is_csv_like %}
            <a href="https://docs.google.com/spreadsheets/d/import?url={{ res.url | urlencode }}&output=csv"
               target="_blank" class="btn btn-outline-secondary" title="Abrir en Google Sheets">
                <i class="fab fa-google me-1"></i> Hoja de cálculo
            </a>
            {% endif %}
            {% endif %}
            <a href="{{ h.url_for('dataset.read', id=pkg.name) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Volver al dataset
            </a>
        </div>

        <!-- 🔹 Metadatos en tarjetas (versión profesional) -->
        <div class="row">
            <div class="col-md-6">
                <h3><i class="fas fa-info-circle me-2 text-muted"></i> Sobre este recurso</h3>
                <table class="table table-sm table-borderless">
                    <tr><th>Formato:</th><td><span class="badge bg-secondary">{{ res.format.upper() }}</span></td></tr>
                    <tr><th>Licencia:</th><td>{{ h.get_license_extra(res.license_id) or res.license_title or 'CC BY-SA' }}</td></tr>
                    <tr><th>Subido:</th><td>{{ h.render_datetime(res.created, date_format='%d de %B de %Y') }}</td></tr>
                    <tr><th>Actualizado (datos):</th><td>{{ h.render_datetime(res.last_modified or pkg.metadata_modified, date_format='%d de %B de %Y') }}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h3><i class="fas fa-shield-alt me-2 text-muted"></i> Calidad y uso</h3>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-{{ 'warning' if not res.datastore_active else 'success' }}"
                         role="progressbar"
                         style="width: {{ 30 if not res.datastore_active else 100 }}%;">
                    </div>
                </div>
                <p class="text-muted">
                    {% if res.datastore_active %}
                    <i class="fas fa-check-circle text-success me-1"></i> Listo para análisis (DataStore activo)
                    {% else %}
                    <i class="fas fa-clock text-warning me-1"></i> Pendiente de procesamiento para vistas interactivas
                    {% endif %}
                </p>
                <small class="text-muted">
                    <i class="fas fa-lightbulb me-1"></i>
                    Recursos en CSV/Excel con DataStore permiten filtrar, graficar y exportar sin descargar.
                </small>
            </div>
        </div>
    </div>
</div>