{% ckan_extends %}

{% block custom_styles %}
  {{ super() }}
  <link rel="stylesheet" href="/hn_theme.css" />
{% endblock %}
  <script>
function loadCsvPreview(resourceId, pkgName, fileName) {
  const el = document.getElementById('csv-preview-' + resourceId);
  el.innerHTML = '<p class="text-center text-muted"><i class="fa fa-spinner fa-spin me-1"></i> {{ _("Cargando...") }}</p>';

  const url = `/dataset/${pkgName}/resource/${resourceId}/download/${fileName}`;

  fetch(url)
    .then(r => r.ok ? r.text() : Promise.reject())
    .then(text => {
      const lines = text.split('\n').filter(l => l.trim());
      if (lines.length === 0) throw 'empty';

      const headers = lines[0].split(',').map(h => h.trim());
      const rows = lines.slice(1, 6).map(line =>
        line.split(',').map(cell => cell.trim().replace(/^"(.*)"$/, '$1'))
      );

      let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr>';
      headers.forEach(h => html += `<th scope="col">${h || '&nbsp;'}</th>`);
      html += '</tr></thead><tbody>';

      rows.forEach(row => {
        html += '<tr>';
        for (let i = 0; i < headers.length; i++) {
          const v = row[i] || '';
          const safe = v.replace(/&/g, '&amp;').replace(/</g, '<').replace(/>/g, '>');
          html += `<td>${safe}</td>`;
        }
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      el.innerHTML = html;
    })
    .catch(() => {
      el.innerHTML = `<p class="text-center text-danger"><i class="fa fa-exclamation-triangle me-1"></i> {{ _("No se pudo cargar la tabla") }}</p>`;
    });
}

function loadJsonPreview(resourceId, pkgName, fileName) {
  const el = document.getElementById('json-preview-' + resourceId);
  el.innerHTML = '<p class="text-center text-muted"><i class="fa fa-spinner fa-spin me-1"></i> {{ _("Analizando JSON...") }}</p>';

  const url = `/dataset/${pkgName}/resource/${resourceId}/download/${fileName}`;

  fetch(url)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(obj => {
      if (typeof obj !== 'object') throw 'not json';

      const keys = Object.keys(obj).slice(0, 10);
      let html = '<pre class="small bg-light p-3 rounded" style="text-align:left; overflow:auto;"><code>';

      keys.forEach(key => {
        const val = obj[key];
        const type = Array.isArray(val) ? 'array' : typeof val;
        let display = '';

        if (type === 'string') {
          display = `"${val.substring(0, 60).replace(/"/g, '\\"')}${val.length > 60 ? '…' : ''}"`;
        } else if (type === 'object' && val !== null) {
          display = val.constructor === Object ? '{…}' : `[object ${val.constructor.name}]`;
        } else if (Array.isArray(val)) {
          display = `[${val.length} elemento${val.length !== 1 ? 's' : ''}]`;
        } else {
          display = val;
        }

        const color = type === 'string' ? 'text-warning' : type === 'number' ? 'text-primary' : type === 'boolean' ? 'text-success' : 'text-muted';
        html += `<span class="text-success">"${key}"</span>: <span class="${color}">${display}</span>,\n`;
      });

      if (Object.keys(obj).length > 10) {
        html += `… <span class="text-muted">// +${Object.keys(obj).length - 10} claves</span>`;
      }
      html += '</code></pre>';
      el.innerHTML = html;
    })
    .catch(() => {
      el.innerHTML = `
        <div class="alert alert-warning small p-2 mb-0">
          <i class="fa fa-exclamation-triangle me-1"></i>
          {{ _("El archivo no es un JSON válido o es demasiado grande.") }}
        </div>`;
    });
}
  </script>